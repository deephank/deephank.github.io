<html>
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-114741779-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-114741779-1');
    </script>

    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Hank Lu">
    
    
    <meta name="title" property="og:title" content="短網址系統開發心得 - Hank Lu" />
    <meta name="description" property="og:description" content="&lt;p&gt;因為在 Tedxntust 的行銷部工作，平常發發 FB 都會去用奇怪的短網址服務，剛好最近社團要架網站，所以就順便開發了一個短網址的系統。可以用自己的 Domain 提升信任感，還能追蹤數據。我也把他開源了，大家有空來貢獻吧 &lt;a href=&#34;https://github.com/kehanlu/shorten_url&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;source code&lt;/a&gt;&lt;br&gt;">
    
    
    
    <meta name="image" property="og:image"  content="" />
    
    <!-- CSS -->
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <link rel="stylesheet" href="/css/bulma.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/prettify.css">
    <script src="/js/fontawesome.js"></script>
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <title>短網址系統開發心得 - Hank Lu</title>
    
    
</head>

<script src="/js/prettify.js"></script>

<body onload="PR.prettyPrint()">
    <nav class="navbar is-fixed-top has-shadow is-spaced" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
        <img src="/images/thinking_face.png"width="30" height="30">
      </a>

      <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>
    <div class="navbar-menu" id="navMenu">
      <div class="navbar-start">
        <!-- <a class="navbar-item" href="/">
          <span class="icon">
            <i class="fas fa-star"></i>
          </span>
          <span>About Me</span>
        </a> -->
        <a class="navbar-item" href="/">
          <span class="icon">
            <i class="fas fa-book"></i>
          </span>
          <span>Blog</span>
        </a>
      </div>

      <div class="navbar-end">
        <div class="navbar-item">
          <div class="field is-grouped">
            <a target="_blank" class="navbar-item" href="https://github.com/kehanlu">
              <img src="/images/github.svg">
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>
    <div class="main">
        <section class="section">
            <div class="container">
                <article>
    <h1 class="title">短網址系統開發心得</h1>
    <h2 class="subtitle">
        2018-07-10
    </h2>

    <div class="content">
        <p>因為在 Tedxntust 的行銷部工作，平常發發 FB 都會去用奇怪的短網址服務，剛好最近社團要架網站，所以就順便開發了一個短網址的系統。可以用自己的 Domain 提升信任感，還能追蹤數據。我也把他開源了，大家有空來貢獻吧 <a href="https://github.com/kehanlu/shorten_url" target="_blank" rel="noopener">source code</a><br><a id="more"></a></p>
<p><img src="https://img.shields.io/badge/Django-2.0-blue.svg" alt=""></p>
<h2 id="需要討論的問題"><a href="#需要討論的問題" class="headerlink" title="需要討論的問題"></a>需要討論的問題</h2><p>開發這個系統，實作上沒有很困難，但網路上似乎沒有比較完整的方法，所以就記錄一下開發的細節。有幾個需要思考的點：</p>
<ol>
<li>整體架構</li>
<li>社群網站如何產生預覽？ </li>
<li>「短」網址如何產生？</li>
<li>使用哪一種方法 redirect？ (javascript or python / 301 or 302)</li>
<li>如何記錄流量</li>
</ol>
<h2 id="第一版的功能"><a href="#第一版的功能" class="headerlink" title="第一版的功能"></a>第一版的功能</h2><p>目前釋出的第一個版本，有幾個功能：</p>
<h3 id="快速縮網址"><a href="#快速縮網址" class="headerlink" title="快速縮網址"></a>快速縮網址</h3><p>用起來有點像 <a href="https://goo.gl" target="_blank" rel="noopener">goo.gl</a></p>
<h3 id="自訂短網址"><a href="#自訂短網址" class="headerlink" title="自訂短網址"></a>自訂短網址</h3><p>可以自訂短網址的名稱，如：<code>xxx.com/links/活動報名</code>，還能自訂 FB 預覽縮圖、標題、內容，對於臉書粉絲團來說非常實用的功能。像醬子：<br><img src="https://i.imgur.com/4fs2IOR.png" alt=""></p>
<h3 id="查看數據"><a href="#查看數據" class="headerlink" title="查看數據"></a>查看數據</h3><p>每次點擊都把他記錄起來，有點像是 google analysis 的作用，就自己刻了一個，像醬子：</p>
<p><img src="https://i.imgur.com/zM90mPW.png" alt=""></p>
<h2 id="整體架構"><a href="#整體架構" class="headerlink" title="整體架構"></a>整體架構</h2><p>短網址主要的思路很簡單，</p>
<ol>
<li>使用者從 xxx.com/meow 進入伺服器</li>
<li>到資料庫裡找 meow 所對應的網址</li>
<li>做一些統計之類的事</li>
<li>將他導向目標</li>
</ol>
<pre><code class="python"># models.py
class ShortURL(models.Model):
    timestamp = models.DateTimeField(default=timezone.now)
    target = models.CharField(max_length=200)
    name = models.CharField(max_length=200, blank=True)
    title = models.CharField(max_length=200, blank=True)
    description = models.TextField(blank=True)
    thumbnail = models.ImageField(upload_to=&#39;thumbnails/%m/&#39;, blank=True)
    permanent_url = models.CharField(max_length=20, blank=True)
    mode = models.IntegerField(default=301)
</code></pre>
<h3 id="社群網站如何產生預覽？"><a href="#社群網站如何產生預覽？" class="headerlink" title="社群網站如何產生預覽？"></a>社群網站如何產生預覽？</h3><p>基本上當你貼了一個網址之後，網站會讓一隻爬蟲程式去看看你的網站，FB 會用到 Title、Description、image等內容，如果你有特別設定 <code>meta tag</code> 他會優先使用 meta tag 的內容，若沒有的話才是亂亂抓（通常是第一段文字及第一張照片）。</p>
<p>所以為了要「騙」過這支爬蟲程式，我就 render 一個假的、帶有自訂 meta 的網頁，然後再用 javascript redirect 至目標網站。在使用上因為馬上就被重導，所以使用者不會感覺到發生了什麼事。</p>
<pre><code class="python"># views.py
# ...
context = {
    &#39;url&#39;: shortcut.target,
    &#39;title&#39;: shortcut.title,
    &#39;description&#39;: shortcut.description,
    &#39;image&#39;: image_url
}
return render(request, &#39;links/redirect.html&#39;, context)
</code></pre>
<pre><code class="html">&lt;meta property=&quot;og:title&quot; content=&quot;{{title}}&quot; /&gt;
&lt;meta property=&quot;og:description&quot; content=&quot;{{description}}&quot; /&gt;
&lt;meta property=&quot;og:image&quot; content=&quot;{{image}}&quot; /&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
    window.location.href = &quot;{{url}}&quot;;
&lt;/script&gt;
</code></pre>
<h3 id="永久短網址如何產生？"><a href="#永久短網址如何產生？" class="headerlink" title="永久短網址如何產生？"></a>永久短網址如何產生？</h3><p><em>備註：我設計時，每一個產生的網址都會有一個永久代碼。</em></p>
<p>說到永久短網址，就要產生一段夠短的字串來對應原本的網址，要兼具「短」且要「唯一」，且必須具有一定的亂度，避免不公開的網址被連結到（如內部的表單）。</p>
<p>所以我使用的方法是「<code>用objects.create() 的 id + hash_salt 經過 hash 後取前 6 位，再換成 BASE64</code>」。加入 Hash salt 讓網址規則更難被找到。使用 BASE 64 讓網址可以為 A-Z,a-z,0-9 加上 -_ ，如：<code>xxx.com/links/A-w0</code> 變得更有短網址的樣子了呢。</p>
<pre><code class="python">permanent_url = base64.b64encode(
    hashlib.md5((str(shortcut.id) + HASH_SALT).encode(&#39;utf-8&#39;)).digest(), altchars=b&quot;-_&quot;)[:6].decode(&quot;utf-8&quot;)
</code></pre>
<p>但這樣的方法有一個缺點，就是 md5[:6] 並不一定唯一，但經過實驗後大約要生成 100000 個網址之後才會發生碰撞，所以就先安心地用吧～若真的遇到了也可以用加字的方式解決。</p>
<h4 id="或許可以試試看"><a href="#或許可以試試看" class="headerlink" title="或許可以試試看"></a>或許可以試試看</h4><p>將 id HASH 成 32 位元，2^32=4294967296 可以用 6 個字 64^6=68719476736 包起來。</p>
<h3 id="使用哪種方法-redirect？"><a href="#使用哪種方法-redirect？" class="headerlink" title="使用哪種方法 redirect？"></a>使用哪種方法 redirect？</h3><p><em>關於301及302其實只是我在設計時的想法，但由於301會被快取，導致沒辦法記錄瀏覽量，實際上還是都是 302</em></p>
<blockquote>
<p><strong>301 redirect</strong><br>301 Move Permanently。可以簡單地理解為該資源已經被永久改變了位置。</p>
<p><strong>302 redirect</strong><br>302 Found，原始描述短語為 Moved Temporarily。可以簡單的理解為該資源原本確實存在，但已經被臨時改變了位置；換而言之，就是請求的資源暫時駐留在不同的URI下，故而除非特別指定了快取頭部指示，該狀態碼不可快取。</p>
</blockquote>
<h4 id="快速轉址"><a href="#快速轉址" class="headerlink" title="快速轉址"></a>快速轉址</h4><p>在實作快速轉址時，我是使用 301 重導的概念去做，因為使用者只是快速的經過這個網站，所以我在<code>後端</code>就直接 redirect(‘target.com’) ，也暗示 FB 直接去找原本的網站找東西。</p>
<h4 id="自訂轉址"><a href="#自訂轉址" class="headerlink" title="自訂轉址"></a>自訂轉址</h4><p>自訂轉址由於是要讓爬蟲程式造訪假網站，再由<code>前端javascript</code> 重導至新網站，算是以 302 的概念去實作。</p>
<pre><code class="python"># views.py
if shortcut.mode == 301:
    return redirect(shortcut.target)
elif shortcut.mode == 302:
    # ... 
    context = {
        &#39;url&#39;: shortcut.target,
        &#39;title&#39;: shortcut.title,
        &#39;description&#39;: shortcut.description,
        &#39;image&#39;: image_url
    }
    return render(request, &#39;links/redirect.html&#39;, context)
</code></pre>
<h3 id="如何記錄流量？"><a href="#如何記錄流量？" class="headerlink" title="如何記錄流量？"></a>如何記錄流量？</h3><p>每點擊一次，進到 views.py 時就 create 一個 object， ForeignKey 至連結的網址，到時候要製作統計圖時就能很方便的撈資料了～順便記錄了訪問 ip 也可以統計不重複的ip瀏覽量。</p>
<p>然後再用 <a href="https://www.chartjs.org/" target="_blank" rel="noopener">Chart.js</a> 畫圖。</p>
<pre><code class="python"># models.py
class Viewer(models.Model):
    timestamp = models.DateTimeField(default=timezone.now)
    short_url = models.ForeignKey(
        ShortURL, on_delete=models.CASCADE, related_name=&#39;viewers&#39;)
    ip = models.CharField(max_length=100)
</code></pre>

    </div>

</article>

<div id="toc">
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#需要討論的問題"><span class="toc-text">需要討論的問題</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第一版的功能"><span class="toc-text">第一版的功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#快速縮網址"><span class="toc-text">快速縮網址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自訂短網址"><span class="toc-text">自訂短網址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看數據"><span class="toc-text">查看數據</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#整體架構"><span class="toc-text">整體架構</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#社群網站如何產生預覽？"><span class="toc-text">社群網站如何產生預覽？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#永久短網址如何產生？"><span class="toc-text">永久短網址如何產生？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#或許可以試試看"><span class="toc-text">或許可以試試看</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用哪種方法-redirect？"><span class="toc-text">使用哪種方法 redirect？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#快速轉址"><span class="toc-text">快速轉址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自訂轉址"><span class="toc-text">自訂轉址</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#如何記錄流量？"><span class="toc-text">如何記錄流量？</span></a></li></ol></li></ol>
</div>


<section class="section">
    <div class="container">
        <div class="comments" id="comments">
            
        </div>
    </div>
</section>
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
var gitment = new Gitment({
  id: 'item.title',
  owner: 'kehanlu',
  repo: 'kehanlu.github.io',
  oauth: {
    client_id: 'ab9a2a976727d1280778',
    client_secret: 'd2ae4e759980df1644640761690e2c32d58c05b4',
  },
})
gitment.render(document.getElementById('comments'))

$('meta[name="description"]').attr('content',$('.content p').first().text())
</script>
            </div>
        </section>
    </div>
    <div class="footer">
        <footer class="footer">
  <div class="content has-text-centered">
    <p>
      powered by Hank
    </p>
  </div>
</footer>
    </div>

</body>
</html>

<script src="/js/footer.js"></script>
<script src="/js/prettify.js"></script>